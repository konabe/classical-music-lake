name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ----------------------------------------
      # CDK 依存関係インストール & AWS 認証
      # (API URL 取得のためにフロントエンドビルドより前に実行)
      # ----------------------------------------
      - name: Install CDK dependencies
        run: npm install
        working-directory: cdk

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      # ----------------------------------------
      # デプロイ済みスタックから API Base URL を取得
      # CDK Outputs の ApiUrl を GITHUB_OUTPUT に書き出す
      # ----------------------------------------
      - name: Get API Base URL from CloudFormation
        id: get-api-url
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name ClassicalMusicLakeStack \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
            --output text)
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

      # ----------------------------------------
      # フロントエンド: Nuxt SPA ビルド
      # ----------------------------------------
      - name: Install frontend dependencies
        run: npm install

      - name: Build frontend
        run: npm run generate
        env:
          # CloudFormation Outputs から取得した API Gateway URL をセット
          NUXT_PUBLIC_API_BASE_URL: ${{ steps.get-api-url.outputs.api_url }}

      # ----------------------------------------
      # CDK デプロイ
      # (インフラ更新 + ビルド済みフロントエンドを S3 へ反映)
      # ----------------------------------------
      - name: CDK Deploy
        run: npm run deploy
        working-directory: cdk
